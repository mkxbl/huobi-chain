language: rust
rust: nightly
dist: bionic
sudo: true

env:
  global:
    - RUST_BACKTRACE=full
    - USE_SYS_ROCKSDB: true
    - FMT: true
    - CHECK: true
    - TEST: true

before_cache:
  - rm -rf ./target/debug/incremental/

cache:
  apt: true
  directories:
    - $TRAVIS_HOME/.cargo/

git:
  depth: 2
  submodules: false

if: branch IN (master, release) OR fork = true OR tag =~ ^v

addons:
  apt:
    packages:
    - gcc
    - librocksdb5.8
    - librocksdb-dev

install: ./devtools/ci/install.sh
script: ./devtools/ci/script.sh

matrix:
  include:
    - name: do ci
      if: 'tag IS NOT present'
    - name: linux package
      if: 'tag IS present'
      os: linux
      script: 
        - cargo build --release
        - ./devtools/ci/package.sh
    - name: osx package
      if: 'tag IS present'
      os: osx
      script: 
        - cargo build --release
        - ./devtools/ci/package.sh
    - name: windows package
      if: 'tag IS present'
      os: windows
      script: 
        - cargo build --release
        - ./devtools/ci/package.sh

deploy:
  provider: releases
  skip_cleanup: true
  overwrite: true
  api_key:
    secure: "need Huobi-Group github oauth token"
  file:
    - huobi-chain-$TRAVIS_TAG-linux.tar.gz
    - huobi-chain-$TRAVIS_TAG-osx.tar.gz
    - huobi-chain-$TRAVIS_TAG-windows.zip
  on:
    tags: true
